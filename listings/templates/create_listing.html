{% extends "core/skeleton.html" %}
{% block title %}Sell on Textbook X Change{% endblock %}
{% load static %}

{% block body %}
    {% include "core/navbar_minimal.html" %}
{% endblock %}

{% block body-container %}
<div class="py-3 text-center">
    <h1>Create a Listing</h1>
    <!-- Progress Bar -->
    <div class="progress mb-4">
        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
            Step 1 of 4
        </div>
    </div>
</div>

<div class="container d-flex justify-content-center align-items-center">
    <div class="row w-100">
        <div class="col-md-6 mx-auto text-center">
            <form id="listing-form" action="{% url 'listings:create_listing' %}" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <!-- Step 1: Book Details -->
                <div id="step-1">
                    <h3>Step 1: Book Details</h3>

                    <div class="form-group">
                        <label for="title">Title</label>
                        {{ form.title }}
                    </div>

                    <div class="form-group">
                        <label for="isbn">ISBN</label>
                        {{ form.isbn }}
                    </div>

                    <div class="form-group">
                        <label for="author">Author</label>
                        {{ form.author }}
                    </div>
                <div class="form-group">
                    <label for="condition">Condition</label>
                    {{ form.condition }}
                    {% if form.condition.errors %}
        <div class="text-danger small mt-1">
            {{ form.condition.errors|striptags }}
        </div>
    {% endif %}
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    {{ form.location }}
                    {% if form.location.errors %}
        <div class="text-danger small mt-1">
            {{ form.location.errors|striptags }}
        </div>
    {% endif %}
                </div>
                <div class="form-group">
                    <label for="coursecode">Course Code</label>
                    {{ form.coursecode }}
                    {% if form.coursecode.errors %}
                        <div class="text-danger small mt-1">
                            {{ form.coursecode.errors|striptags }}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="additional_details">Description</label>
                    {{ form.additional_details }}
                    {{ form.additional_details.errors|striptags }}
                </div>

                <div class="text-end">
                    <button type="button" id="next-to-step-2" class="btn btn-primary mt-3">Next</button>
                </div>
                </div>

                <!-- Step 2: Upload Images -->
                <div id="step-2" style="display: none;">
                    <h3>Step 2: Upload Images</h3>

                    <div class="form-group">
                        <label for="image">Upload Images</label>
                        <input type="file" name="images" id="id_images" multiple class="form-control">
                        {{ form.image }}
                    </div>

                    <button type="button" id="back-to-step-1" class="btn btn-secondary mt-4">Back</button>
                    <button type="button" id="next-to-step-3" class="btn btn-primary mt-4">Next</button>
                </div>

                <!-- Step 3: Pricing Information -->
                <div id="step-3" style="display: none;">
                    <h3>Step 3: Pricing</h3>
                    <div class="text-center mb-3">
                        <h5>Suggested Price</h5>
                        <div class="position-relative d-inline-block p-2 bg-dark text-white rounded"
                             style="z-index: 10;">
                            Our suggested price: <span id="suggested-price-display">$-</span>
                            <div class="arrow-down"
                                 style="position: absolute; left: 50%; transform: translateX(-50%); top: 100%; width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid black;"></div>
                        </div>
                    </div>
                    <div class="progress-stacked">
                        <div class="progress" style="width: 33%">
                            <div class="progress-bar bg-warning"></div>
                        </div>
                        <div class="progress" style="width: 34%">
                            <div class="progress-bar bg-success"></div>
                        </div>
                        <div class="progress" style="width: 33%">
                            <div class="progress-bar bg-danger"></div>
                        </div>
                    </div>
                    <div class="form-group mt-3">
                        <label for="price">Your Price</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            {{ form.price }}
                        </div>
                    </div>
                    <button type="button" id="back-to-step-2" class="btn btn-secondary mt-4">Back</button>
                    <button type="button" id="next-to-step-4" class="btn btn-primary mt-4">Next</button>
                </div>

                <!-- Step 4: Confirm and Submit -->
                <div id="step-4" style="display: none;">
                    <h3>Step 4: Confirm Your Listing</h3>
                    <p>Review all details and submit.</p>
                    <ul class="list-group text-start">
                        <li class="list-group-item"><strong>Title:</strong> <span id="confirm-title"></span></li>
                        <li class="list-group-item"><strong>ISBN:</strong> <span id="confirm-isbn"></span></li>
                        <li class="list-group-item"><strong>Author:</strong> <span id="confirm-author"></span></li>
                        <li class="list-group-item"><strong>Condition:</strong> <span id="confirm-condition"></span></li>
                        <li class="list-group-item"><strong>Location:</strong> <span id="confirm-location"></span></li>
                        <li class="list-group-item"><strong>Course Code:</strong> <span id="confirm-coursecode"></span></li>
                        <li class="list-group-item"><strong>Description:</strong> <span id="confirm-additional_details"></span></li>
                        <li class="list-group-item"><strong>Your Price:</strong> <span id="confirm-price"></span></li>
                    </ul>
                    <button type="button" id="back-to-step-3" class="btn btn-secondary mt-4">Back</button>
                    <button type="submit" class="btn btn-success mt-4">Submit Listing</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- used ai and documentation  -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const progressBar = document.getElementById("progress-bar");
    const isbnField = document.getElementById("id_isbn");
    // Trigger fetch eBay Prices way before step 3 so it's ready in time.
    fetchSuggestedPrice(isbnField.value.trim());

    const step1 = document.getElementById("step-1");
    const step2 = document.getElementById("step-2");
    const step3 = document.getElementById("step-3");
    const step4 = document.getElementById("step-4");

    const nextToStep2 = document.getElementById("next-to-step-2");
    const backToStep1 = document.getElementById("back-to-step-1");
    const nextToStep3 = document.getElementById("next-to-step-3");
    const backToStep2 = document.getElementById("back-to-step-2");
    const nextToStep4 = document.getElementById("next-to-step-4");
    const backToStep3 = document.getElementById("back-to-step-3");

    nextToStep2.addEventListener("click", function() {
        step1.style.display = "none";
        step2.style.display = "block";
        progressBar.style.width = "50%";
        progressBar.textContent = "Step 2 of 4";
    });

    backToStep1.addEventListener("click", function() {
        step2.style.display = "none";
        step1.style.display = "block";
        progressBar.style.width = "25%";
        progressBar.textContent = "Step 1 of 4";
    });

    nextToStep3.addEventListener("click", function() {
        step2.style.display = "none";
        step3.style.display = "block";
        progressBar.style.width = "75%";
        progressBar.textContent = "Step 3 of 4";
    });

    backToStep2.addEventListener("click", function() {
        step3.style.display = "none";
        step2.style.display = "block";
        progressBar.style.width = "50%";
        progressBar.textContent = "Step 2 of 4";
    });

    nextToStep4.addEventListener("click", function() {
        step3.style.display = "none";
        step4.style.display = "block";
        progressBar.style.width = "100%";
        progressBar.textContent = "Step 4 of 4";

        // Autofill Step 4 with user inputs
        document.getElementById("confirm-title").textContent = document.getElementById("id_title").value;
        document.getElementById("confirm-isbn").textContent = document.getElementById("id_isbn").value;
        document.getElementById("confirm-author").textContent = document.getElementById("id_author").value;
        document.getElementById("confirm-condition").textContent = document.getElementById("id_condition").value;
        document.getElementById("confirm-location").textContent = document.getElementById("id_location").value;
        document.getElementById("confirm-coursecode").textContent = document.getElementById("id_coursecode").value;
        document.getElementById("confirm-additional_details").textContent = document.getElementById("id_additional_details").value;
        document.getElementById("confirm-price").textContent = "$" + (document.getElementById("id_price").value || "N/A");
    });

    backToStep3.addEventListener("click", function() {
        step4.style.display = "none";
        step3.style.display = "block";
        progressBar.style.width = "75%";
        progressBar.textContent = "Step 3 of 4";
    });
    
    // Fetch eBay Prices for Suggested Price
    function fetchSuggestedPrice(isbn) {
        if (!isbn) return;
        fetch("{% url 'pricing_engine:get_suggestions' %}?isbn=" + encodeURIComponent(isbn))
            .then(response => response.json())
            .then(data => {
                const usedData = data.used || {};
                const priceDisplay = document.getElementById("suggested-price-display");
                if (usedData.median_price) {
                    priceDisplay.textContent = "$" + usedData.median_price;
                    document.getElementById("id_price").value = usedData.median_price || "";
                } else {
                    priceDisplay.textContent = "N/A";
                }
            })
            .catch(error => console.error("Error fetching price:", error));
    }
});
</script>
{% endblock %}
