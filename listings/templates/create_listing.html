{% extends "core/base.html" %}
{% block title %}Sell on Textbook X Change{% endblock title %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="row w-100">
        <div class="col-md-6 mx-auto text-center">

            <h1>Create a Listing</h1>

            <!-- Progress Bar -->
            <div class="progress mb-4">
                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                    Step 1 of 4
                </div>
            </div>

            <form id="listing-form" action="{% url 'listings:create_listing' %}" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <!-- Step 1: Book Details -->
                <div id="step-1">
                    <h3>Step 1: Book Details</h3>

                    <div class="form-group">
                        <label for="title">Title</label>
                        {{ form.title }}
                    </div>

                    <div class="form-group">
                        <label for="isbn">ISBN</label>
                        {{ form.isbn }}
                    </div>

                    <div class="form-group">
                        <label for="author">Author</label>
                        {{ form.author }}
                    </div>
                <div class="form-group">
                    <label for="condition">Condition</label>
                    {{ form.condition }}
                    {% if form.condition.errors %}
        <div class="text-danger small mt-1">
            {{ form.condition.errors|striptags }}
        </div>
    {% endif %}
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    {{ form.location }}
                    {% if form.location.errors %}
        <div class="text-danger small mt-1">
            {{ form.location.errors|striptags }}
        </div>
    {% endif %}
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    {{ form.description }}
                    {{ form.description.errors|striptags }}
                </div>

                <div class="text-end">
                    <button type="button" id="next-to-step-2" class="btn btn-primary mt-3">Next</button>
                </div>
                </div>

                <!-- Step 2: Upload Images -->
                <div id="step-2" style="display: none;">
                    <h3>Step 2: Upload Images</h3>

                    <div class="form-group">
                        <label for="image">Upload Images</label>
                        {{ form.image }}
                    </div>

                    <button type="button" id="back-to-step-1" class="btn btn-secondary mt-4">Back</button>
                    <button type="button" id="next-to-step-3" class="btn btn-primary mt-4">Next</button>
                </div>

                <!-- Step 3: Pricing Information -->
                <div id="step-3" style="display: none;">
                    <h3>Step 3: Pricing</h3>
                    <div class="form-group">
                        <label for="suggested-price">Suggested Price </label>
                        <input type="text" id="suggested-price" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="price">Your Price</label>
                        {{ form.price }}
                        {% if form.price.errors %}
        <div class="text-danger small mt-1">
            {{ form.price.errors|striptags }}
        </div>
    {% endif %}
                    </div>

                    <!-- Table displaying quartile data -->
                    <div id="price-table-container">
                        <h3>Price Breakdown</h3>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Median Price</th>
                                    <th>First Quartile (Q1)</th>
                                    <th>Third Quartile (Q3)</th>
                                    <th>Suggested List Price</th>
                                    <th>Suggested Buy Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td id="median-price">-</td>
                                    <td id="q1-price">-</td>
                                    <td id="q3-price">-</td>
                                    <td id="suggested-list-price">-</td>
                                    <td id="suggested-buy-price">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <button type="button" id="back-to-step-2" class="btn btn-secondary mt-4">Back</button>
                    <button type="button" id="next-to-step-4" class="btn btn-primary mt-4">Next</button>
                </div>

                <!-- Step 4: Confirm and Submit -->
                <div id="step-4" style="display: none;">
                    <h3>Step 4: Confirm Your Listing</h3>
                    <p>Review all details and submit.</p>
                    <ul class="list-group text-start">
                        <li class="list-group-item"><strong>Title:</strong> <span id="confirm-title"></span></li>
                        <li class="list-group-item"><strong>ISBN:</strong> <span id="confirm-isbn"></span></li>
                        <li class="list-group-item"><strong>Author:</strong> <span id="confirm-author"></span></li>
                        <li class="list-group-item"><strong>Condition:</strong> <span id="confirm-condition"></span></li>
                        <li class="list-group-item"><strong>Location:</strong> <span id="confirm-location"></span></li>
                        <li class="list-group-item"><strong>Description:</strong> <span id="confirm-description"></span></li>
                        <li class="list-group-item"><strong>Your Price:</strong> <span id="confirm-price"></span></li>
                    </ul>
                    <button type="button" id="back-to-step-3" class="btn btn-secondary mt-4">Back</button>
                    <button type="submit" class="btn btn-success mt-4">Submit Listing</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- used ai and documentation  -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const progressBar = document.getElementById("progress-bar");
    const isbnField = document.getElementById("id_isbn");

    const step1 = document.getElementById("step-1");
    const step2 = document.getElementById("step-2");
    const step3 = document.getElementById("step-3");
    const step4 = document.getElementById("step-4");

    const nextToStep2 = document.getElementById("next-to-step-2");
    const backToStep1 = document.getElementById("back-to-step-1");
    const nextToStep3 = document.getElementById("next-to-step-3");
    const backToStep2 = document.getElementById("back-to-step-2");
    const nextToStep4 = document.getElementById("next-to-step-4");
    const backToStep3 = document.getElementById("back-to-step-3");

    nextToStep2.addEventListener("click", function() {
        step1.style.display = "none";
        step2.style.display = "block";
        progressBar.style.width = "50%";
        progressBar.textContent = "Step 2 of 4";
    });

    backToStep1.addEventListener("click", function() {
        step2.style.display = "none";
        step1.style.display = "block";
        progressBar.style.width = "25%";
        progressBar.textContent = "Step 1 of 4";
    });

    nextToStep3.addEventListener("click", function() {
        step2.style.display = "none";
        step3.style.display = "block";
        progressBar.style.width = "75%";
        progressBar.textContent = "Step 3 of 4";

        // Fetch eBay Prices on Step 3 Load
        fetchSuggestedPrice(isbnField.value.trim());
    });

    backToStep2.addEventListener("click", function() {
        step3.style.display = "none";
        step2.style.display = "block";
        progressBar.style.width = "50%";
        progressBar.textContent = "Step 2 of 4";
    });

    nextToStep4.addEventListener("click", function() {
        step3.style.display = "none";
        step4.style.display = "block";
        progressBar.style.width = "100%";
        progressBar.textContent = "Step 4 of 4";

          // Autofill Step 4 with user inputs
          document.getElementById("confirm-title").textContent = document.getElementById("id_title").value;
          document.getElementById("confirm-isbn").textContent = document.getElementById("id_isbn").value;
          document.getElementById("confirm-author").textContent = document.getElementById("id_author").value;
          document.getElementById("confirm-condition").textContent = document.getElementById("id_condition").value;
          document.getElementById("confirm-location").textContent = document.getElementById("id_location").value;
          document.getElementById("confirm-description").textContent = document.getElementById("id_description").value;
          document.getElementById("confirm-price").textContent = "$" + (document.getElementById("id_price").value || "N/A");
    });

    backToStep3.addEventListener("click", function() {
        step4.style.display = "none";
        step3.style.display = "block";
        progressBar.style.width = "75%";
        progressBar.textContent = "Step 3 of 4";
    });
    
    // Fetch eBay Prices for Suggested Price
    function fetchSuggestedPrice(isbn) {
        if (!isbn) return;

        fetch("{% url 'pricing_engine:get_suggestions' %}?isbn=" + isbn)
            .then(response => response.json())
            .then(data => {
                const usedData = data.used || {};
                document.getElementById("suggested-price").value = usedData.median_price || "N/A";
                document.getElementById("id_price").value = usedData.median_price || "";
                document.getElementById("median-price").textContent = "$" + (usedData.median_price || "-");
                document.getElementById("q1-price").textContent = "$" + (usedData.q1_price || "-");
                document.getElementById("q3-price").textContent = "$" + (usedData.q3_price || "-");
                document.getElementById("suggested-list-price").textContent = "$" + (usedData.suggested_list_price || "-");
                document.getElementById("suggested-buy-price").textContent = "$" + (usedData.suggested_buy_price || "-");
            })
            .catch(error => console.error("Error fetching price:", error));
    }
});
</script>
{% endblock %}