{% extends "core/base.html" %}
{% block title %}Dashboard - Your Listings{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4 bangers-font">Dashboard</h2>

    <!-- Create Listing Button -->
    <div class="text-end">
        <a href="{% url 'listings:prelist' %}" class="btn btn-sm">
            <i class="far fa-plus-square fa-2x"></i> 
        </a>
    </div>

 <!-- Listings Display as Rows -->
<div class="list-group">
    {% for listing in listings %}
        {% if not listing.sold %}  <!-- Corrected If Condition -->
        <div class="list-group-item d-flex align-items-center justify-content-between p-3 border rounded shadow-sm mb-3">
            
            <div class="me-3">
                {% if listing.image %}
                    <img src="{{ listing.image.url }}" class="img-thumbnail" width="80" height="80" alt="{{ listing.title }}">
                {% else %}
                    <img src="https://placehold.co/80" class="img-thumbnail" alt="No Image">
                {% endif %}
            </div>

            <!-- Middle: Book Details (Title & ISBN Stacked) -->
            <div class="flex-grow-1">
                <strong>{{ listing.title }}</strong> <br> <!-- Title in Bold -->
                <small class="text-muted">{{ listing.isbn }}</small>  <!-- ISBN in Smaller Font -->
            </div>

            <!-- Right: Actions & Price -->
            <div class="text-end">
                <p class="fw-bold mt-2">${{ listing.price }}</p>  <!-- Price Below Icons -->
            </div>
        </div>
        {% endif %}
    {% empty %}
        <p class="text-center">No listings available.</p>
    {% endfor %}
</div>

    <!-- Orders Section -->
    <h3 class="mt-5 text-center bangers-font">Your Sold Books</h3>
    <div class="list-group">
        {% for order in orders %}
        <div class="list-group-item d-flex align-items-center justify-content-between p-3 border rounded shadow-sm mb-3">
            
            <div class="me-3">
                {% if order.listing.image %}
                    <img src="{{ order.listing.image.url }}" class="img-thumbnail" width="80" height="80" alt="{{ order.listing.title }}">
                {% else %}
                    <img src="https://placehold.co/80" class="img-thumbnail" alt="No Image">
                {% endif %}
            </div>

            <!-- Middle: Order Details -->
            <div class="flex-grow-1">
                <strong>{{ order.listing.title }}</strong> <br>
                <small class="text-muted">{{ order.listing.isbn }}</small><br>
                <small class="text-muted"><strong>Buyer:</strong> {{ order.buyer.username }}</small>
                <p><strong>Shipping Address:</strong> {{ order.shipping_info }}</p>
            </div>

            <!-- Right: Shipment Status & Actions -->
            <div class="text-end">
                {% if order.has_shipped %}
                    <h5><span class="badge text-bg-primary">Shipped</span></h5>
                {% else %}
                    <button class="btn btn-warning btn-sm confirm-shipment" data-order-id="{{ order.id }}">
                        Confirm Shipment
                    </button>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p class="text-center">No books sold yet.</p>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".confirm-shipment").forEach(button => {
        button.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");

            fetch(`/orders/confirm_shipment/${orderId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(error => console.error("Error:", error));
        });
    });
});
</script>
{% endblock %}
